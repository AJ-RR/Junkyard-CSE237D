#!/bin/bash
set -e

# Config
KEY=/root/.ssh/id_ed25519
USER=autograder
HOST=your.server.ip.or.hostname
SUBMISSION_DIR="/autograder/submission"
RESULTS_JSON="/autograder/results/results.json"
ZIP_FILE="/tmp/submission.zip"
$CLUSTER_IP = "10.42.0.6"
$CLUSTER_PORT = "30080"

# Zip the submission
cd "$SUBMISSION_DIR"
zip -r "$ZIP_FILE" ./*
cd -

# Stream the zip file directly to the remote curl via SSH
RESPONSE=$(ssh -i "$KEY" -o StrictHostKeyChecking=no "$USER@$HOST" \
  "cat > /tmp/submission.zip && curl -s -F name=student -F image=assignment1 -F script=@/tmp/submission.zip http://$CLUSTER_IP:$CLUSTER_PORT/submit" \
  < "$ZIP_FILE")

# Parse and write results
SCORE=$(echo "$RESPONSE" | jq -r '.score // 0')
OUTPUT=$(echo "$RESPONSE" | jq -r '.output // "No output"')
VISIBILITY=$(echo "$RESPONSE" | jq -r '.visibility // "visible"')
STDOUT_VISIBILITY=$(echo "$RESPONSE" | jq -r '.stdout_visibility // "visible"')

mkdir -p "$(dirname $RESULTS_JSON)"
cat <<EOF > "$RESULTS_JSON"
{
  "score": $SCORE,
  "output": "$OUTPUT",
  "visibility": "$VISIBILITY",
  "stdout_visibility": "$STDOUT_VISIBILITY"
}
EOF
